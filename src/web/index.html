<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>xcstrings Translations</title>
    <style>
      :root {
        color-scheme: light;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue",
          Arial, sans-serif;
        margin: 0;
        background: linear-gradient(180deg, #f8f8fc 0%, #f2f2f7 100%);
        color: #1c1c1e;
      }
      main {
        width: 100%;
        margin: 0;
        padding: 6.25rem 4vw 4rem;
      }
      header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        margin-bottom: 1rem;
      }
      h1 {
        font-size: 2rem;
        font-weight: 700;
        letter-spacing: -0.02em;
        margin: 0;
      }
      nav.nav-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 30;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.9rem;
        padding: 0.75rem 4vw;
        background: rgba(255, 255, 255, 0.96);
        backdrop-filter: blur(16px);
        border-bottom: 1px solid rgba(60, 60, 67, 0.08);
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
      }
      .nav-left,
      .nav-center,
      .nav-right {
        display: flex;
        align-items: center;
        gap: 0.6rem;
      }
      .nav-left {
        flex: 1 1 16rem;
      }
      .nav-center {
        flex: 1 1 auto;
        justify-content: center;
        flex-wrap: wrap;
        gap: 0.4rem 0.75rem;
      }
      .nav-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6e6e73;
      }
      .nav-right {
        flex: 0 0 auto;
      }
      .reference-row {
        opacity: 0.75;
      }
      input:not(.search-field),
      textarea {
        font: inherit;
        border-radius: 12px;
        border: 1px solid transparent;
        background: transparent;
        padding: 0.5rem 0.75rem;
        transition:
          border-color 0.2s ease,
          box-shadow 0.2s ease,
          background 0.2s ease;
        color: inherit;
      }
      textarea {
        resize: vertical;
        min-height: 2.6rem;
      }
      input:not(.search-field):focus,
      textarea:focus {
        outline: none;
        border-color: #0a84ff;
        box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.12);
        background: #ffffff;
      }
      .search-field {
        flex: 1 1 auto;
        font: inherit;
        border-radius: 12px;
        border: 1px solid rgba(60, 60, 67, 0.18);
        background: rgba(255, 255, 255, 0.95);
        padding: 0.5rem 0.75rem;
        transition:
          border-color 0.2s ease,
          box-shadow 0.2s ease,
          background 0.2s ease;
        color: inherit;
      }
      .search-field:focus {
        outline: none;
        border-color: #0a84ff;
        box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.12);
        background: #ffffff;
      }
      button {
        font: inherit;
        border: none;
        border-radius: 12px;
        background: #0a84ff;
        color: #fff;
        padding: 0.5rem 0.95rem;
        cursor: pointer;
        transition:
          transform 0.15s ease,
          box-shadow 0.2s ease,
          background 0.2s ease;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 20px rgba(10, 132, 255, 0.25);
      }
      button:active {
        transform: translateY(0);
        box-shadow: none;
      }
      button.secondary {
        background: rgba(60, 60, 67, 0.08);
        color: #1c1c1e;
        box-shadow: none;
      }
      button.secondary:hover {
        background: rgba(60, 60, 67, 0.12);
        box-shadow: none;
      }
      button.refresh-button {
        background: rgba(118, 118, 128, 0.12);
        color: #1c1c1e;
        padding: 0.3rem 0.6rem;
        border-radius: 999px;
        box-shadow: none;
      }
      button.refresh-button:hover {
        background: rgba(118, 118, 128, 0.2);
        transform: none;
        box-shadow: none;
      }
      button.add-button {
        padding: 0.35rem 0.8rem;
        border-radius: 999px;
        font-size: 1.1rem;
        line-height: 1;
        box-shadow: 0 8px 20px rgba(10, 132, 255, 0.25);
      }
      .language-select-wrapper {
        position: relative;
      }
      .language-select {
        appearance: none;
        background: rgba(118, 118, 128, 0.12);
        color: #1c1c1e;
        padding: 0.45rem 2.4rem 0.45rem 0.75rem;
        border-radius: 999px;
        border: 1px solid transparent;
        min-width: 11rem;
        box-shadow: none;
        cursor: pointer;
      }
      .language-select:focus {
        outline: none;
        border-color: #0a84ff;
        box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.12);
        background: #ffffff;
      }
      .language-select-wrapper::after {
        content: "\25BE";
        position: absolute;
        right: 0.9rem;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(60, 60, 67, 0.6);
        pointer-events: none;
        font-size: 0.8rem;
      }
      .translation-row {
        transition: background 0.2s ease;
      }
      .translation-row:hover {
        background: rgba(245, 245, 247, 0.6);
      }
      .translation-row .key-tools {
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      .translation-row:hover .key-tools,
      .translation-row:focus-within .key-tools {
        opacity: 1;
      }
      .lang-button {
        background: rgba(118, 118, 128, 0.12);
        color: #1c1c1e;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-size: 0.9rem;
        box-shadow: none;
      }
      .lang-button:hover {
        background: rgba(118, 118, 128, 0.18);
      }
      .lang-button.active {
        background: #0a84ff;
        color: #fff;
        box-shadow: 0 6px 16px rgba(10, 132, 255, 0.35);
      }
      .lang-button.subtle {
        background: rgba(118, 118, 128, 0.08);
        color: #3a3a3c;
      }
      .lang-button.subtle.active {
        background: #5856d6;
        color: #fff;
      }
      .language-row {
        display: flex;
        gap: 0.4rem;
        flex-wrap: wrap;
      }
      table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        margin-top: 1.8rem;
        background: rgba(255, 255, 255, 0.96);
        border-radius: 24px;
        box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
        overflow: hidden;
      }
      th,
      td {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid rgba(60, 60, 67, 0.08);
        vertical-align: top;
      }
      th {
        text-align: left;
        font-size: 0.78rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #6e6e73;
        background: rgba(249, 249, 251, 0.9);
      }
      tr:last-child td {
        border-bottom: none;
      }
      .key-cell {
        width: 22%;
      }
      .comment-cell {
        width: 26%;
      }
      .translation-cell {
        width: auto;
      }
      .key-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
      }
      .key-input {
        flex: 1;
        font-size: 1rem;
        font-weight: 600;
        padding: 0.35rem 0.25rem;
      }
      .key-tools {
        display: flex;
        gap: 0.35rem;
      }
      .icon-button {
        background: rgba(118, 118, 128, 0.16);
        color: #1c1c1e;
        padding: 0.25rem 0.55rem;
        border-radius: 999px;
        box-shadow: none;
        min-width: 2rem;
      }
      .icon-button:hover {
        background: rgba(118, 118, 128, 0.22);
        transform: none;
      }
      .icon-button.danger {
        background: rgba(255, 69, 58, 0.18);
        color: #d70015;
      }
      .icon-button.danger:hover {
        background: rgba(255, 69, 58, 0.28);
      }
      .icon-button.small {
        padding: 0.2rem 0.45rem;
        min-width: unset;
        font-size: 0.85rem;
      }
      .comment-input {
        width: 100%;
        min-height: 2.6rem;
      }
      .translation-wrapper {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .translation-input {
        min-height: 3.1rem;
        width: 100%;
      }
      .reference-line {
        display: flex;
        gap: 0.35rem;
        align-items: baseline;
        font-size: 0.8rem;
        color: #636366;
        flex-wrap: wrap;
        margin-bottom: 0.4rem;
      }
      .reference-line .reference-value {
        color: #1c1c1e;
        font-weight: 500;
        white-space: pre-wrap;
      }
      .status {
        margin-top: 1.2rem;
        color: #0a7;
        font-weight: 500;
        min-height: 1.2rem;
      }
      .status.error {
        color: #ff3b30;
      }
      .plural-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .plural-row {
        display: flex;
        gap: 0.5rem;
        align-items: flex-start;
      }
      .plural-row label {
        min-width: 4rem;
        font-weight: 600;
        text-transform: capitalize;
        padding-top: 0.35rem;
      }
      .plural-row textarea {
        flex: 1;
      }
      .plural-actions {
        margin-top: 0.25rem;
        display: flex;
        gap: 0.4rem;
        align-items: center;
      }
      .plural-picker {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .plural-picker.hidden {
        display: none;
      }
      .plural-option {
        background: rgba(118, 118, 128, 0.12);
        color: #1c1c1e;
        padding: 0.35rem 0.65rem;
        border-radius: 999px;
        font-size: 0.82rem;
        border: none;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .plural-option:hover {
        background: rgba(118, 118, 128, 0.2);
      }
      .plural-empty {
        font-style: italic;
        color: #636366;
      }
      @media (max-width: 900px) {
        main {
          padding: 5.5rem 1.25rem 3rem;
        }
        nav.nav-bar {
          padding: 0.6rem 1.25rem;
          gap: 0.6rem;
        }
        .nav-left,
        .nav-center,
        .nav-right {
          flex: 1 1 100%;
          justify-content: center;
        }
        .nav-right {
          justify-content: flex-end;
        }
        table,
        thead,
        tbody,
        th,
        td,
        tr {
          display: block;
        }
        thead {
          display: none;
        }
        tr {
          margin-bottom: 1.5rem;
          border: 1px solid rgba(60, 60, 67, 0.1);
          border-radius: 20px;
          padding: 1rem;
          background: #fff;
          box-shadow: 0 16px 32px rgba(15, 23, 42, 0.08);
        }
        td {
          border: none;
          padding: 0.5rem 0;
        }
        .key-header {
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <nav class="nav-bar">
      <div class="nav-left">
        <input
          type="text"
          id="search"
          class="search-field"
          placeholder="Search keys or translations"
        />
        <button class="refresh-button" id="refresh" title="Refresh list">
          ⟳
        </button>
      </div>
      <div class="nav-center">
        <label class="nav-label" for="language-select">Language</label>
        <div class="language-select-wrapper">
          <select
            id="language-select"
            class="language-select"
            title="Choose language"
          ></select>
        </div>
        <label class="nav-label" for="reference-select">Reference</label>
        <div class="language-select-wrapper">
          <select
            id="reference-select"
            class="language-select"
            title="Choose reference language"
          ></select>
        </div>
      </div>
      <div class="nav-right">
        <button class="add-button" id="add-translation" title="Add translation">
          ＋
        </button>
      </div>
    </nav>
    <main>
      <header>
        <h1>Localizable.xcstrings</h1>
      </header>
      <div id="status" class="status"></div>
      <table>
        <thead>
          <tr>
            <th>Key</th>
            <th>Comment</th>
            <th id="language-header">Translation</th>
          </tr>
        </thead>
        <tbody id="translations-body"></tbody>
      </table>
    </main>
    <script>
      const LANGUAGE_REGIONS = {
        en: "US",
        "en-gb": "GB",
        "en-us": "US",
        fr: "FR",
        de: "DE",
        es: "ES",
        it: "IT",
        ja: "JP",
        ko: "KR",
        zh: "CN",
        "zh-hans": "CN",
        "zh-hant": "CN",
        pt: "PT",
        "pt-br": "BR",
        ru: "RU",
        nl: "NL",
        sv: "SE",
        da: "DK",
        fi: "FI",
        nb: "NO",
        pl: "PL",
        cs: "CZ",
      };

      const LANGUAGE_LABELS = {
        en: "English",
        "en-gb": "English (UK)",
        "en-us": "English (US)",
        fr: "French",
        de: "German",
        es: "Spanish",
        it: "Italian",
        ja: "Japanese",
        ko: "Korean",
        zh: "Chinese",
        "zh-hans": "Chinese (Simplified)",
        "zh-hant": "Chinese (Traditional)",
        pt: "Portuguese",
        "pt-br": "Portuguese (Brazil)",
        ru: "Russian",
        nl: "Dutch",
        sv: "Swedish",
        da: "Danish",
        fi: "Finnish",
        nb: "Norwegian",
        pl: "Polish",
        cs: "Czech",
      };

      const PLURAL_CASES = ["zero", "one", "two", "few", "many", "other"];
      const state = {
        languages: [],
        currentLanguage: null,
        referenceLanguage: null,
        items: [],
        drafts: [],
      };

      function toFlag(code) {
        if (!code) {
          return "🏳️";
        }
        const normalized = code.toLowerCase();
        const region = LANGUAGE_REGIONS[normalized];
        if (region) {
          return regionToFlag(region);
        }
        const base = normalized.split(/[-_]/)[0];
        if (LANGUAGE_REGIONS[base]) {
          return regionToFlag(LANGUAGE_REGIONS[base]);
        }
        if (/^[a-z]{2}$/.test(base)) {
          return regionToFlag(base);
        }
        return "🏳️";
      }

      function regionToFlag(region) {
        if (!region) {
          return "🏳️";
        }
        const upper = region.toUpperCase();
        if (!/^[A-Z]{2}$/.test(upper)) {
          return "🏳️";
        }
        const codePoints = upper
          .split("")
          .map((ch) => 127397 + ch.charCodeAt(0));
        return String.fromCodePoint(...codePoints);
      }

      function languageLabel(code) {
        if (!code) {
          return "";
        }
        const normalized = code.toLowerCase();
        if (LANGUAGE_LABELS[normalized]) {
          return LANGUAGE_LABELS[normalized];
        }
        const base = normalized.split(/[-_]/)[0];
        if (LANGUAGE_LABELS[base]) {
          return LANGUAGE_LABELS[base];
        }
        return code;
      }

      function translationHeaderText() {
        if (!state.currentLanguage) {
          return "Translation";
        }
        return `Translation — ${toFlag(state.currentLanguage)} ${languageLabel(state.currentLanguage)}`;
      }

      function dropDraft(draftId) {
        if (!draftId) {
          return;
        }
        state.drafts = state.drafts.filter(
          (draft) => draft.__draftId !== draftId,
        );
      }

      function renderLanguageControls() {
        const languageSelect = document.getElementById("language-select");
        const referenceSelect = document.getElementById("reference-select");
        languageSelect.innerHTML = "";
        referenceSelect.innerHTML = "";

        const englishCandidate =
          state.languages.find((lang) => lang.toLowerCase() === "en") ||
          state.languages.find((lang) => lang.toLowerCase().startsWith("en-"));

        if (
          !state.currentLanguage ||
          !state.languages.includes(state.currentLanguage)
        ) {
          state.currentLanguage =
            englishCandidate || state.languages[0] || null;
        }

        if (
          !state.referenceLanguage ||
          !state.languages.includes(state.referenceLanguage)
        ) {
          state.referenceLanguage =
            state.currentLanguage ||
            englishCandidate ||
            state.languages[0] ||
            null;
        }

        state.languages.forEach((lang) => {
          const option = document.createElement("option");
          option.value = lang;
          option.textContent = `${toFlag(lang)} ${languageLabel(lang)}`;
          languageSelect.appendChild(option);

          const refOption = document.createElement("option");
          refOption.value = lang;
          refOption.textContent = `${toFlag(lang)} ${languageLabel(lang)}`;
          referenceSelect.appendChild(refOption);
        });

        if (
          state.currentLanguage &&
          state.languages.includes(state.currentLanguage)
        ) {
          languageSelect.value = state.currentLanguage;
        } else if (state.languages.length) {
          state.currentLanguage = state.languages[0];
          languageSelect.value = state.currentLanguage;
        } else {
          languageSelect.value = "";
        }

        if (
          state.referenceLanguage &&
          state.languages.includes(state.referenceLanguage)
        ) {
          referenceSelect.value = state.referenceLanguage;
        } else if (state.languages.length) {
          state.referenceLanguage = state.currentLanguage || state.languages[0];
          referenceSelect.value = state.referenceLanguage;
        } else {
          referenceSelect.value = "";
        }

        document.getElementById("language-header").textContent =
          translationHeaderText();
      }

      async function fetchLanguages() {
        const res = await fetch("/api/languages");
        const data = await res.json();
        state.languages = data.languages;
        renderLanguageControls();
      }

      async function fetchTranslations(query = "") {
        const params = query ? `?q=${encodeURIComponent(query)}` : "";
        const res = await fetch(`/api/translations${params}`);
        const data = await res.json();
        state.items = data.items;
        state.drafts = state.drafts.filter((draft) => {
          if (!draft.key) {
            return true;
          }
          return !state.items.some((item) => item.key === draft.key);
        });
        renderTable();
      }

      function referenceFor(item) {
        if (!state.referenceLanguage) {
          return null;
        }
        return item.translations[state.referenceLanguage] || null;
      }

      function renderTable() {
        const tbody = document.getElementById("translations-body");
        tbody.innerHTML = "";
        const rows = [...state.drafts, ...state.items];
        rows.forEach((item) => {
          const isDraft = Boolean(item.__draft);
          if (!item.translations) {
            item.translations = {};
          }

          const tr = document.createElement("tr");
          tr.className = "translation-row";

          const keyCell = document.createElement("td");
          keyCell.className = "key-cell";
          const keyHeader = document.createElement("div");
          keyHeader.className = "key-header";

          const keyInput = document.createElement("input");
          keyInput.type = "text";
          keyInput.className = "key-input";
          keyInput.value = item.key || "";
          keyInput.placeholder = isDraft ? "New key" : "";
          keyInput.spellcheck = false;
          if (isDraft) {
            keyInput.dataset.draft = item.__draftId;
          }

          let activeKey = item.key || "";

          keyInput.addEventListener("focus", () => {
            keyInput.setSelectionRange(0, keyInput.value.length);
          });
          keyInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
              event.preventDefault();
              keyInput.blur();
            } else if (event.key === "Escape") {
              keyInput.value = activeKey;
              keyInput.blur();
            }
          });
          keyInput.addEventListener("blur", async () => {
            const nextKey = keyInput.value.trim();
            if (!nextKey) {
              setStatus("Key cannot be empty", true);
              if (isDraft) {
                keyInput.value = "";
              } else {
                keyInput.value = activeKey;
              }
              return;
            }
            if (nextKey === activeKey) {
              keyInput.value = activeKey;
              return;
            }
            if (isDraft) {
              activeKey = nextKey;
              item.key = nextKey;
              setStatus("Key ready");
              return;
            }
            try {
              await renameKey(activeKey, nextKey);
              activeKey = nextKey;
              setStatus("Key renamed");
              await fetchTranslations(document.getElementById("search").value);
            } catch (error) {
              setStatus(error.message, true);
              keyInput.value = activeKey;
            }
          });

          const keyTools = document.createElement("div");
          keyTools.className = "key-tools";

          const copyBtn = document.createElement("button");
          copyBtn.type = "button";
          copyBtn.className = "icon-button";
          copyBtn.title = "Copy key";
          copyBtn.textContent = "📋";
          copyBtn.addEventListener("click", async () => {
            if (!activeKey) {
              setStatus("Set a key before copying", true);
              return;
            }
            try {
              await navigator.clipboard.writeText(activeKey);
              setStatus("Key copied to clipboard");
            } catch (_) {
              setStatus("Copy not available in this browser", true);
            }
          });

          const deleteKeyBtn = document.createElement("button");
          deleteKeyBtn.type = "button";
          deleteKeyBtn.className = "icon-button danger";
          deleteKeyBtn.title = "Delete key";
          deleteKeyBtn.textContent = "🗑️";
          deleteKeyBtn.addEventListener("click", async () => {
            if (isDraft) {
              dropDraft(item.__draftId);
              renderTable();
              setStatus("Draft removed");
              return;
            }
            if (!confirm(`Delete key "${activeKey}" for all languages?`)) {
              return;
            }
            const res = await fetch(
              `/api/keys/${encodeURIComponent(activeKey)}`,
              { method: "DELETE" },
            );
            if (res.ok) {
              setStatus("Key deleted");
              await fetchTranslations(document.getElementById("search").value);
            } else {
              let message = "Failed to delete key";
              try {
                const err = await res.json();
                if (err?.error) {
                  message = err.error;
                }
              } catch (_) {
                // ignore
              }
              setStatus(message, true);
            }
          });

          keyTools.appendChild(copyBtn);
          keyTools.appendChild(deleteKeyBtn);

          keyHeader.appendChild(keyInput);
          keyHeader.appendChild(keyTools);
          keyCell.appendChild(keyHeader);
          tr.appendChild(keyCell);

          const commentCell = document.createElement("td");
          commentCell.className = "comment-cell";

          const reference =
            !isDraft && state.referenceLanguage ? referenceFor(item) : null;
          if (reference) {
            const refLine = document.createElement("div");
            refLine.className = "reference-line";

            const refFlag = document.createElement("span");
            refFlag.textContent = toFlag(state.referenceLanguage);

            const refLabel = document.createElement("span");
            refLabel.textContent = languageLabel(state.referenceLanguage);

            const separator = document.createElement("span");
            separator.textContent = "—";

            const refValue = document.createElement("span");
            refValue.className = "reference-value";
            refValue.textContent = reference.value ? reference.value : "—";

            refLine.appendChild(refFlag);
            refLine.appendChild(refLabel);
            refLine.appendChild(separator);
            refLine.appendChild(refValue);

            commentCell.appendChild(refLine);
          }

          const commentInput = document.createElement("textarea");
          commentInput.className = "comment-input";
          commentInput.placeholder = "Add a comment";
          commentInput.value = item.comment || "";
          commentInput.addEventListener("change", async (event) => {
            if (!activeKey) {
              setStatus("Set a key before saving comments", true);
              commentInput.value = "";
              return;
            }
            if (isDraft) {
              setStatus("Save the translation before adding comments", true);
              commentInput.value = item.comment || "";
              return;
            }
            const res = await fetch("/api/comments", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                key: activeKey,
                comment: event.target.value || null,
              }),
            });
            if (res.ok) {
              item.comment = event.target.value;
              setStatus("Comment saved");
            } else {
              setStatus("Failed to save comment", true);
            }
          });
          commentCell.appendChild(commentInput);
          tr.appendChild(commentCell);

          const translationCell = document.createElement("td");
          translationCell.className = "translation-cell";
          const translationWrapper = document.createElement("div");
          translationWrapper.className = "translation-wrapper";

          if (
            state.currentLanguage &&
            !item.translations[state.currentLanguage]
          ) {
            item.translations[state.currentLanguage] = {};
          }
          const translation = state.currentLanguage
            ? item.translations[state.currentLanguage] || {}
            : {};

          const textarea = document.createElement("textarea");
          textarea.className = "translation-input";
          textarea.placeholder = `Enter ${languageLabel(state.currentLanguage || "")} translation`;
          textarea.value = translation.value || "";
          textarea.addEventListener("change", async (event) => {
            if (!state.currentLanguage) {
              setStatus("Select a language before saving", true);
              return;
            }
            if (!activeKey) {
              setStatus("Set a key before saving a translation", true);
              textarea.value = translation.value || "";
              return;
            }
            try {
              await upsertTranslation(
                {
                  key: activeKey,
                  language: state.currentLanguage,
                  value: event.target.value,
                },
                "Translation saved",
              );
              if (isDraft) {
                dropDraft(item.__draftId);
                await fetchTranslations(
                  document.getElementById("search").value,
                );
              } else {
                translation.value = event.target.value;
              }
            } catch (error) {
              setStatus(error.message, true);
              textarea.value = translation.value || "";
            }
          });

          translationWrapper.appendChild(textarea);

          const pluralVariations =
            (translation.variations && translation.variations.plural) || {};
          const pluralKeys = Object.keys(pluralVariations);

          const pluralList = document.createElement("div");
          pluralList.className = "plural-list";

          if (pluralKeys.length === 0) {
            const empty = document.createElement("div");
            empty.className = "plural-empty";
            empty.textContent = "No plural forms yet.";
            pluralList.appendChild(empty);
          }

          pluralKeys.forEach((caseKey) => {
            const entry = pluralVariations[caseKey] || {};
            const row = document.createElement("div");
            row.className = "plural-row";

            const label = document.createElement("label");
            label.textContent = caseKey;
            row.appendChild(label);

            const variantTextarea = document.createElement("textarea");
            variantTextarea.rows = 1;
            variantTextarea.value = entry.value || "";
            variantTextarea.addEventListener("change", async (event) => {
              if (!activeKey) {
                setStatus("Set a key before saving plural translations", true);
                variantTextarea.value = entry.value || "";
                return;
              }
              const updates = { plural: {} };
              updates.plural[caseKey] = { value: event.target.value };
              try {
                await upsertTranslation(
                  {
                    key: activeKey,
                    language: state.currentLanguage,
                    variations: updates,
                  },
                  `Plural '${caseKey}' saved`,
                );
                if (isDraft) {
                  dropDraft(item.__draftId);
                  await fetchTranslations(
                    document.getElementById("search").value,
                  );
                } else {
                  entry.value = event.target.value;
                }
              } catch (error) {
                setStatus(error.message, true);
                variantTextarea.value = entry.value || "";
              }
            });
            row.appendChild(variantTextarea);

            const deleteVariant = document.createElement("button");
            deleteVariant.type = "button";
            deleteVariant.className = "icon-button small danger";
            deleteVariant.title = `Remove ${caseKey} plural`;
            deleteVariant.textContent = "🗑️";
            deleteVariant.addEventListener("click", async () => {
              if (!activeKey) {
                setStatus("Set a key before removing plural forms", true);
                return;
              }
              const updates = { plural: {} };
              updates.plural[caseKey] = { value: null };
              try {
                await upsertTranslation(
                  {
                    key: activeKey,
                    language: state.currentLanguage,
                    variations: updates,
                  },
                  `Plural '${caseKey}' removed`,
                );
                dropDraft(item.__draftId);
                await fetchTranslations(
                  document.getElementById("search").value,
                );
              } catch (error) {
                setStatus(error.message, true);
              }
            });
            row.appendChild(deleteVariant);

            pluralList.appendChild(row);
          });

          translationWrapper.appendChild(pluralList);

          const pluralActions = document.createElement("div");
          pluralActions.className = "plural-actions";

          const addBtn = document.createElement("button");
          addBtn.type = "button";
          addBtn.className = "secondary";
          addBtn.textContent = "Add plural form";

          const picker = document.createElement("div");
          picker.className = "plural-picker hidden";

          const availableCases = PLURAL_CASES.filter(
            (caseKey) => !pluralKeys.includes(caseKey),
          );

          if (availableCases.length === 0) {
            addBtn.disabled = true;
            addBtn.textContent = "All plural cases added";
          } else {
            availableCases.forEach((caseKey) => {
              const optionBtn = document.createElement("button");
              optionBtn.type = "button";
              optionBtn.className = "plural-option";
              optionBtn.textContent = caseKey;
              optionBtn.addEventListener("click", async () => {
                if (!activeKey) {
                  setStatus("Set a key before adding plural forms", true);
                  picker.classList.add("hidden");
                  return;
                }
                const updates = { plural: {} };
                updates.plural[caseKey] = { value: "" };
                try {
                  await upsertTranslation(
                    {
                      key: activeKey,
                      language: state.currentLanguage,
                      variations: updates,
                    },
                    `Plural '${caseKey}' added`,
                  );
                  picker.classList.add("hidden");
                  dropDraft(item.__draftId);
                  await fetchTranslations(
                    document.getElementById("search").value,
                  );
                } catch (error) {
                  setStatus(error.message, true);
                }
              });
              picker.appendChild(optionBtn);
            });
          }

          addBtn.addEventListener("click", () => {
            if (availableCases.length === 0) {
              return;
            }
            picker.classList.toggle("hidden");
          });

          pluralActions.appendChild(addBtn);
          pluralActions.appendChild(picker);
          translationWrapper.appendChild(pluralActions);
          translationCell.appendChild(translationWrapper);
          tr.appendChild(translationCell);

          tbody.appendChild(tr);
        });
      }

      async function upsertTranslation(
        payload,
        successMessage = "Translation saved",
      ) {
        const { key, language } = payload;
        if (!language) {
          throw new Error("Select a language before saving");
        }

        const body = { key, language };
        if (payload.value !== undefined) {
          body.value = payload.value;
        }
        if (payload.state !== undefined) {
          body.state = payload.state;
        }
        if (payload.variations !== undefined) {
          body.variations = payload.variations;
        }

        const res = await fetch("/api/translations", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          let message = `Failed to save translation (${res.status})`;
          try {
            const errorBody = await res.json();
            if (errorBody?.error) {
              message = errorBody.error;
            }
          } catch (_) {
            // ignore JSON parse errors
          }
          throw new Error(message);
        }

        setStatus(successMessage);
      }

      async function renameKey(oldKey, newKey) {
        const res = await fetch(`/api/keys/${encodeURIComponent(oldKey)}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ new_key: newKey }),
        });
        if (!res.ok) {
          let message = `Failed to rename key (${res.status})`;
          try {
            const errorBody = await res.json();
            if (errorBody?.error) {
              message = errorBody.error;
            }
          } catch (_) {
            // ignore JSON parse errors
          }
          throw new Error(message);
        }
      }

      function setStatus(message, isError = false) {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = isError ? "status error" : "status";
        if (message) {
          setTimeout(() => {
            status.textContent = "";
            status.className = "status";
          }, 3500);
        }
      }

      document
        .getElementById("language-select")
        .addEventListener("change", (event) => {
          const next = event.target.value;
          if (!next || state.currentLanguage === next) {
            return;
          }
          state.currentLanguage = next;
          document.getElementById("language-header").textContent =
            translationHeaderText();
          renderTable();
        });

      document
        .getElementById("reference-select")
        .addEventListener("change", (event) => {
          const next = event.target.value || null;
          if (state.referenceLanguage === next) {
            return;
          }
          state.referenceLanguage = next;
          renderTable();
        });

      document.getElementById("refresh").addEventListener("click", () => {
        const query = document.getElementById("search").value;
        fetchTranslations(query);
      });

      document.getElementById("search").addEventListener("input", (event) => {
        const query = event.target.value;
        fetchTranslations(query);
      });

      document
        .getElementById("add-translation")
        .addEventListener("click", () => {
          if (!state.currentLanguage) {
            setStatus("Select a language before adding translations", true);
            return;
          }
          const draftId = `draft-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`;
          const draft = {
            __draft: true,
            __draftId: draftId,
            key: "",
            comment: "",
            translations: {},
          };
          state.drafts.unshift(draft);
          renderTable();
          window.requestAnimationFrame(() => {
            const input = document.querySelector(
              `.key-input[data-draft="${draftId}"]`,
            );
            if (input) {
              input.focus();
            }
          });
        });

      (async function init() {
        await fetchLanguages();
        await fetchTranslations();
      })();
    </script>
  </body>
</html>
